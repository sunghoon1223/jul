import { useState, useEffect, useCallback } from 'react'
import { toast } from '@/hooks/use-toast'

interface CartItem {
  id: string
  name: string
  price: number
  image: string
  quantity: number
  slug: string
}

interface CartState {
  items: CartItem[]
  loading: boolean
  itemsCount: number
  totalAmount: number
}

export function useCart() {
  const [cartState, setCartState] = useState<CartState>({
    items: [],
    loading: true,
    itemsCount: 0,
    totalAmount: 0
  })

  // Load cart from localStorage (ì—ëŸ¬ í•¸ë“¤ë§ ê°•í™”)
  const loadCart = useCallback(() => {
    try {
      // localStorage ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
      if (typeof Storage === 'undefined') {
        console.warn('âš ï¸ localStorageê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
        return [];
      }
      
      const savedCart = localStorage.getItem('shopping_cart')
      if (!savedCart) {
        console.log('ğŸ›’ ìƒˆë¡œìš´ ì¥ë°”êµ¬ë‹ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.');
        return [];
      }
      
      const parsedCart = JSON.parse(savedCart);
      console.log('ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì„±ê³µ:', parsedCart.length, 'ê°œ ì•„ì´í…œ');
      return parsedCart;
    } catch (error) {
      console.error('âŒ ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
      // localStorage ì´ˆê¸°í™” ì‹œë„
      try {
        localStorage.removeItem('shopping_cart');
        console.log('ğŸ”§ ì†ìƒëœ ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°ë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        console.error('âŒ localStorage ì •ë¦¬ ì‹¤íŒ¨:', e);
      }
      return []
    }
  }, [])

  // Save cart to localStorage (ì—ëŸ¬ í•¸ë“¤ë§ ê°•í™”)
  const saveCart = useCallback((items: CartItem[]) => {
    try {
      if (typeof Storage === 'undefined') {
        console.warn('âš ï¸ localStorageê°€ ì§€ì›ë˜ì§€ ì•Šì•„ ì¥ë°”êµ¬ë‹ˆë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      localStorage.setItem('shopping_cart', JSON.stringify(items))
      console.log('ğŸ’¾ ì¥ë°”êµ¬ë‹ˆ ì €ì¥ ì„±ê³µ:', items.length, 'ê°œ ì•„ì´í…œ');
    } catch (error) {
      console.error('âŒ ì¥ë°”êµ¬ë‹ˆ ì €ì¥ ì‹¤íŒ¨:', error);
      // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
      if (error.name === 'QuotaExceededError') {
        console.warn('âš ï¸ ë¸Œë¼ìš°ì € ì €ì¥ì†Œê°€ ê°€ë“ì°¸. ì¼ë¶€ ë°ì´í„°ë¥¼ ì‚­ì œí•´ì£¼ì„¸ìš”.');
      }
    }
  }, [])

  // Initialize cart (useWishlist íŒ¨í„´ ì ìš©)
  useEffect(() => {
    const items = loadCart()
    const itemsCount = items.reduce((sum: number, item: CartItem) => sum + item.quantity, 0)
    const totalAmount = items.reduce((sum: number, item: CartItem) => sum + item.price * item.quantity, 0)
    
    setCartState({
      items,
      loading: false,
      itemsCount,
      totalAmount
    })
  }, [loadCart])

  // Add item to cart (í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ íŒ¨í„´ ì‚¬ìš©)
  const addItem = useCallback((item: Omit<CartItem, 'quantity'> & { quantity?: number }) => {
    console.log('ğŸ›’ useCart.addItem í•¨ìˆ˜ ì‹œì‘:', item.name, 'ìˆ˜ëŸ‰:', item.quantity || 1)
    console.log('ğŸ“‹ í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ:', cartState)
    
    setCartState(prevState => {
      console.log('ğŸ”„ ì´ì „ ìƒíƒœ:', prevState)
      const currentItems = prevState.items
      const existingItem = currentItems.find(i => i.id === item.id)
      
      let updatedItems: CartItem[]
      if (existingItem) {
        console.log('ğŸ”„ ê¸°ì¡´ ìƒí’ˆ ìˆ˜ëŸ‰ ì¦ê°€:', existingItem.name, existingItem.quantity, '->', existingItem.quantity + (item.quantity || 1))
        updatedItems = currentItems.map(i => 
          i.id === item.id 
            ? { ...i, quantity: i.quantity + (item.quantity || 1) }
            : i
        )
      } else {
        console.log('â• ìƒˆë¡œìš´ ìƒí’ˆ ì¶”ê°€:', item.name)
        updatedItems = [...currentItems, { ...item, quantity: item.quantity || 1 }]
      }
      
      const itemsCount = updatedItems.reduce((sum, item) => sum + item.quantity, 0)
      const totalAmount = updatedItems.reduce((sum, item) => sum + item.price * item.quantity, 0)
      
      console.log('ğŸ’¾ ì¥ë°”êµ¬ë‹ˆ ì €ì¥ ì‹œë„:', updatedItems.length, 'ê°œ ì•„ì´í…œ, ì´', itemsCount, 'ê°œ')
      
      // localStorage ì €ì¥
      saveCart(updatedItems)
      
      const newState = {
        items: updatedItems,
        loading: false,
        itemsCount,
        totalAmount
      }
      
      console.log('âœ… ìƒˆë¡œìš´ ìƒíƒœ ë°˜í™˜:', newState)
      console.log('ğŸ”¢ itemsCount ê°’:', itemsCount) // ì¶”ê°€ ë””ë²„ê¹…
      
      // ìƒíƒœê°€ ì¦‰ì‹œ ë°˜ì˜ë˜ë„ë¡ ê°•ì œ ë¦¬ë Œë”ë§ íŠ¸ë¦¬ê±°
      setTimeout(() => {
        console.log('â° ì§€ì—°ëœ ìƒíƒœ í™•ì¸ - itemsCount:', newState.itemsCount)
      }, 100)
      
      return newState
    })
    
    toast({
      title: "ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë¨",
      description: "ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."
    })
  }, [saveCart])

  // Remove item (í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ íŒ¨í„´ ì‚¬ìš©)
  const removeItem = useCallback((itemId: string) => {
    setCartState(prevState => {
      const updatedItems = prevState.items.filter(item => item.id !== itemId)
      const itemsCount = updatedItems.reduce((sum, item) => sum + item.quantity, 0)
      const totalAmount = updatedItems.reduce((sum, item) => sum + item.price * item.quantity, 0)
      
      // localStorage ì €ì¥
      saveCart(updatedItems)
      
      return {
        items: updatedItems,
        loading: false,
        itemsCount,
        totalAmount
      }
    })
    
    toast({
      title: "ìƒí’ˆ ì œê±°ë¨",
      description: "ì¥ë°”êµ¬ë‹ˆì—ì„œ ìƒí’ˆì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤."
    })
  }, [saveCart])

  // Update item quantity (í•¨ìˆ˜í˜• ì—…ë°ì´íŠ¸ íŒ¨í„´ ì‚¬ìš©)
  const updateQuantity = useCallback((itemId: string, quantity: number) => {
    if (quantity <= 0) {
      return removeItem(itemId)
    }
  
    setCartState(prevState => {
      const updatedItems = prevState.items.map(item => 
        item.id === itemId ? { ...item, quantity } : item
      )
      
      const itemsCount = updatedItems.reduce((sum, item) => sum + item.quantity, 0)
      const totalAmount = updatedItems.reduce((sum, item) => sum + item.price * item.quantity, 0)
      
      // localStorage ì €ì¥
      saveCart(updatedItems)
      
      return {
        items: updatedItems,
        loading: false,
        itemsCount,
        totalAmount
      }
    })
    }, [saveCart, removeItem])

  // Clear cart
  const clearCart = useCallback(() => {
    setCartState({
      items: [],
      loading: false,
      itemsCount: 0,
      totalAmount: 0
    })
    
    saveCart([])
  }, [saveCart])

  // Legacy function for backward compatibility
  const addToCart = useCallback(async (productId: string, quantity: number = 1) => {
    console.warn('addToCart with productId is deprecated, use addItem instead')
  }, [])

  return {
    ...cartState,
    addItem,
    addToCart,
    updateQuantity,
    removeItem,
    clearCart
  }
}